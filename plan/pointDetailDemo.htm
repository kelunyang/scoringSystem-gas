<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ•ç¥¨è¨ˆåˆ†æ¨¡æ“¬å™¨</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        body {
            font-family: 'Microsoft JhengHei', 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        
        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }
        
        .info-box {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #409eff;
        }
        
        .controls {
            background: #f5f7fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        
        .control-group {
            margin: 15px 0;
            text-align: center;
        }
        
        .control-group label {
            font-weight: bold;
            margin-right: 10px;
        }
        
        .slider-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin: 15px 0;
        }
        
        input[type="range"] {
            width: 300px;
            height: 6px;
            border-radius: 3px;
            background: #ddd;
            outline: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
        }
        
        input[type="number"] {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            width: 80px;
        }
        
        .voter-count-display {
            font-size: 28px;
            font-weight: bold;
            color: #667eea;
            min-width: 60px;
        }
        
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 5px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            font-weight: bold;
        }
        
        .btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #909399;
        }
        
        .btn-secondary:hover {
            background: #82848a;
        }
        
        .section-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            margin: 30px 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }
        
        .charts-container {
            display: flex;
            gap: 30px;
            margin-top: 30px;
        }
        
        .chart-box {
            flex: 1;
            background: #f9f9f9;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .chart-title {
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 20px;
            color: #333;
        }
        
        .table-container {
            overflow-x: auto;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        
        th, td {
            padding: 12px;
            text-align: center;
            border: 1px solid #e0e0e0;
            font-size: 14px;
        }
        
        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        th.voter-header {
            background: #409eff;
            min-width: 100px;
        }
        
        th.stats-header {
            background: #67c23a;
        }
        
        tr:nth-child(even) {
            background: #f9f9f9;
        }
        
        tr:hover {
            background: #e8f4ff;
        }
        
        .rank-1 { background: #ffd700; font-weight: bold; color: #c7254e; }
        .rank-2 { background: #ffeaa7; }
        .rank-3 { background: #fff4cc; }
        
        .stats-cell {
            background: #f0f9ff;
            font-weight: bold;
        }
        
        .candidate-rank {
            display: inline-block;
            background: #ffd700;
            color: #c7254e;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 5px;
        }
        
        .legend {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 5px 10px;
            background: white;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .legend-color {
            width: 30px;
            height: 20px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ—³ï¸ æŠ•ç¥¨è¨ˆåˆ†æ¨¡æ“¬å™¨</h1>
        <p class="subtitle">ä½¿ç”¨éæ­¸æ·˜æ±°æ’åç³»çµ±é€²è¡Œé»æ•¸åˆ†é…</p>
        
        <div class="info-box">
            <strong>ğŸ’¡ ä½¿ç”¨èªªæ˜ï¼š</strong>
            <ul style="margin: 10px 0; padding-left: 20px;">
                <li>è¨­å®šæŠ•ç¥¨äººæ•¸ï¼ˆæ¯äººçµ¦å…¶ä»–äººæ’åï¼Œä¸å«è‡ªå·±ï¼‰</li>
                <li>è¨­å®šç¸½çé‡‘æ± ï¼ˆæ‰€æœ‰äººåˆ†é…çš„ç¸½åˆ†æ•¸ï¼‰</li>
                <li><strong>è¨ˆç¥¨è¦å‰‡</strong>ï¼š
                    <ul style="margin-top: 5px;">
                        <li>å…ˆæ¯”è¼ƒèª°ç²å¾—æœ€å¤šç¬¬1åç¥¨</li>
                        <li>å¦‚æœç¬¬1åç¥¨ç›¸åŒï¼Œå†æ¯”è¼ƒç¬¬2åç¥¨</li>
                        <li>å¦‚æœç¬¬2åç¥¨ä¹Ÿç›¸åŒï¼Œç¹¼çºŒæ¯”è¼ƒç¬¬3åç¥¨...</li>
                        <li>ä¾æ­¤é¡æ¨ï¼Œç›´åˆ°åˆ†å‡ºå‹è² </li>
                        <li>åªæœ‰æ‰€æœ‰åæ¬¡ç¥¨æ•¸éƒ½ç›¸åŒæ™‚æ‰æœƒä¸¦åˆ—</li>
                    </ul>
                </li>
                <li><strong>çé‡‘åˆ†é…</strong>ï¼šç·šæ€§æ¬Šé‡åˆ†é…ï¼ˆç¬¬1åæ¬Šé‡=nï¼Œç¬¬2åæ¬Šé‡=n-1ï¼Œ...ï¼Œç¬¬nåæ¬Šé‡=1ï¼‰ï¼ŒæŒ‰æ¬Šé‡æ¯”ä¾‹åˆ†é…ç¸½çé‡‘æ± ï¼Œæ‰€æœ‰äººçé‡‘ç¸½å’Œ=ç¸½çé‡‘æ± </li>
            </ul>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <div class="slider-container">
                    <label>æŠ•ç¥¨äººæ•¸ï¼š</label>
                    <input type="range" id="voterSlider" min="2" max="20" value="5" step="1">
                    <span class="voter-count-display" id="voterCount">5</span>
                </div>
            </div>
            
            <div class="control-group">
                <label>ğŸ† çé‡‘æ± è¨­å®šï¼š</label>
                <div style="margin-top: 10px; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; align-items: center;">
                    <span>ç¸½çé‡‘æ± ï¼š<input type="number" id="totalPrize" value="100" min="1" max="10000" style="width: 100px;">åˆ†</span>
                </div>
                <div style="margin-top: 10px; color: #666; font-size: 13px;">
                    ğŸ’¡ æ ¹æ“šæœ€çµ‚æ’ååˆ†é…çé‡‘ï¼Œæ‰€æœ‰äººçš„çé‡‘ç¸½å’Œ = ç¸½çé‡‘æ± 
                </div>
            </div>
            
            <div class="control-group" style="margin-top: 20px;">
                <button class="btn" onclick="generateVotes()">ğŸ² ç”ŸæˆæŠ•ç¥¨</button>
                <button class="btn btn-secondary" onclick="clearVotes()">ğŸ—‘ï¸ æ¸…é™¤</button>
            </div>
        </div>
        
        <div id="resultsSection" style="display: none;">
            <div class="section-title">ğŸ“Š æŠ•ç¥¨çµæœè¡¨æ ¼</div>
            
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color rank-1"></div>
                    <span>ç¬¬ 1 åæŠ•ç¥¨</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color rank-2"></div>
                    <span>ç¬¬ 2 åæŠ•ç¥¨</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color rank-3"></div>
                    <span>ç¬¬ 3 åæŠ•ç¥¨</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: linear-gradient(to right, #4169e1, #87ceeb);"></div>
                    <span>è¡¨é ­ï¼šæ’åé¡è‰²ï¼ˆè¶Šæ·±=è¶Šå‰é¢ï¼‰</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: linear-gradient(to right, #dc143c, #ffb6c1);"></div>
                    <span>å¾—ç¥¨æ•¸ï¼šç¥¨æ•¸é¡è‰²ï¼ˆè¶Šæ·±=è¶Šå¤šç¥¨ï¼‰</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: linear-gradient(to right, #228b22, #90ee90);"></div>
                    <span>çé‡‘ï¼šé‡‘é¡é¡è‰²ï¼ˆè¶Šæ·±=è¶Šå¤šéŒ¢ï¼‰</span>
                </div>
            </div>
            
            <div class="table-container">
                <table id="votingTable"></table>
            </div>
            
            <div class="section-title">ğŸ“ˆ é»æ•¸åˆ†å¸ƒåœ–è¡¨</div>
            
            <div class="charts-container">
                <div class="chart-box">
                    <div class="chart-title">ğŸ† çé‡‘åˆ†é…çµæœ</div>
                    <div id="stackedBarChart"></div>
                </div>
                
                <div class="chart-box">
                    <div class="chart-title">ğŸ“Š æœ€çµ‚æ’ååˆ†å¸ƒ</div>
                    <div id="rankDistributionChart"></div>
                </div>
            </div>
        </div>
        
        <div id="emptyState" style="text-align: center; padding: 60px; color: #999;">
            <p style="font-size: 18px;">ğŸ‘† è«‹è¨­å®šäººæ•¸å’Œé»æ•¸è¦å‰‡ï¼Œç„¶å¾Œé»æ“Šã€Œç”ŸæˆæŠ•ç¥¨ã€é–‹å§‹æ¨¡æ“¬</p>
        </div>
    </div>
    
    <div class="tooltip" id="tooltip"></div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let voterCount = 5;
        let voters = [];
        let candidates = [];
        let votes = [];
        let totalPrize = 100;
        
        // åˆå§‹åŒ–
        document.getElementById('voterSlider').addEventListener('input', function(e) {
            voterCount = parseInt(e.target.value);
            document.getElementById('voterCount').textContent = voterCount;
        });
        
        // ç”ŸæˆæŠ•ç¥¨
        function generateVotes() {
            voters = [];
            candidates = [];
            votes = [];
            
            // è®€å–ç¸½çé‡‘æ± 
            totalPrize = parseFloat(document.getElementById('totalPrize').value) || 100;
            
            // ç”Ÿæˆåƒèˆ‡è€…
            for (let i = 1; i <= voterCount; i++) {
                const person = { id: i, name: `åƒèˆ‡è€… ${i}` };
                voters.push({ ...person });
                candidates.push({ ...person });
            }
            
            // æ¯å€‹é¸èˆ‰äººçµ¦å…¶ä»–å€™é¸äººæ’å
            voters.forEach(voter => {
                const otherCandidates = candidates.filter(c => c.id !== voter.id);
                
                // Fisher-Yates shuffle ç”Ÿæˆéš¨æ©Ÿæ’å
                const shuffled = [...otherCandidates];
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }
                
                // åˆ†é…æ’å
                shuffled.forEach((candidate, index) => {
                    votes.push({
                        voterId: voter.id,
                        candidateId: candidate.id,
                        rank: index + 1
                    });
                });
            });
            
            // é¡¯ç¤ºçµæœ
            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('emptyState').style.display = 'none';
            
            updateTable();
            updateCharts();
        }
        
        // æ¸…é™¤æŠ•ç¥¨
        function clearVotes() {
            voters = [];
            candidates = [];
            votes = [];
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('emptyState').style.display = 'block';
        }
        
        // è¨ˆç®—æ’åå’Œçé‡‘åˆ†é…
        function calculateRankingsAndScores() {
            // è¨ˆç®—æ¯å€‹å€™é¸äººçš„å„åæ¬¡ç¥¨æ•¸åˆ†å¸ƒ
            const candidatesWithStats = candidates.map(candidate => {
                const candidateVotes = votes.filter(v => v.candidateId === candidate.id);
                
                const rankDistribution = {};
                for (let rank = 1; rank < voterCount; rank++) {
                    const count = candidateVotes.filter(v => v.rank === rank).length;
                    rankDistribution[rank] = count;
                }
                
                return {
                    ...candidate,
                    rankDistribution,
                    finalRank: null,
                    allocatedScore: 0
                };
            });
            
            // æ”¹é€²çš„æ’åç®—æ³•ï¼šåŒç¥¨æ™‚å¾€ä¸‹æ¯”è¼ƒä¸‹ä¸€åæ¬¡
            const remainingCandidates = [...candidatesWithStats];
            let currentFinalRank = 1;
            
            while (remainingCandidates.length > 0) {
                // å°å‰©é¤˜å€™é¸äººé€²è¡Œæ’åº
                // æ’åºè¦å‰‡ï¼šä¾æ¬¡æ¯”è¼ƒç¬¬1åç¥¨ã€ç¬¬2åç¥¨ã€ç¬¬3åç¥¨...
                remainingCandidates.sort((a, b) => {
                    for (let rank = 1; rank < voterCount; rank++) {
                        const aVotes = a.rankDistribution[rank] || 0;
                        const bVotes = b.rankDistribution[rank] || 0;
                        
                        if (aVotes !== bVotes) {
                            return bVotes - aVotes; // é™åºï¼šç¥¨æ•¸å¤šçš„æ’å‰é¢
                        }
                    }
                    return 0; // æ‰€æœ‰åæ¬¡éƒ½ç›¸åŒï¼ŒçœŸæ­£çš„ä¸¦åˆ—
                });
                
                // æ‰¾å‡ºç¬¬ä¸€çµ„ï¼ˆå¾—ç¥¨æœ€å¤šçš„ä¸€çµ„ï¼Œå¯èƒ½æœ‰çœŸæ­£çš„ä¸¦åˆ—ï¼‰
                const firstCandidate = remainingCandidates[0];
                const winners = [firstCandidate];
                
                // æª¢æŸ¥æ˜¯å¦æœ‰çœŸæ­£çš„ä¸¦åˆ—ï¼ˆæ‰€æœ‰æ’åç¥¨æ•¸éƒ½ç›¸åŒï¼‰
                for (let i = 1; i < remainingCandidates.length; i++) {
                    const candidate = remainingCandidates[i];
                    let isTie = true;
                    
                    for (let rank = 1; rank < voterCount; rank++) {
                        const firstVotes = firstCandidate.rankDistribution[rank] || 0;
                        const candidateVotes = candidate.rankDistribution[rank] || 0;
                        
                        if (firstVotes !== candidateVotes) {
                            isTie = false;
                            break;
                        }
                    }
                    
                    if (isTie) {
                        winners.push(candidate);
                    } else {
                        break; // å·²ç¶“æ’åºéï¼Œå¾Œé¢çš„ä¸å¯èƒ½å†ä¸¦åˆ—
                    }
                }
                
                // è¨˜éŒ„é€™çµ„ç²å‹è€…çš„ä¸»è¦å¾—ç¥¨ç´šåˆ¥ï¼ˆç¥¨æ•¸æœ€å¤šçš„é‚£ä¸€ç´šï¼‰
                let winningRankLevel = 1;
                let maxVotesAtRank = 0;
                for (let rank = 1; rank < voterCount; rank++) {
                    const votes = firstCandidate.rankDistribution[rank] || 0;
                    if (votes > maxVotesAtRank) {
                        maxVotesAtRank = votes;
                        winningRankLevel = rank;
                    }
                }
                
                // åˆ†é…æ’å
                winners.forEach(winner => {
                    winner.finalRank = currentFinalRank;
                    winner.winningRankLevel = winningRankLevel;
                    winner.winningVotes = maxVotesAtRank;
                });
                
                // å¾å‰©é¤˜å€™é¸äººä¸­ç§»é™¤é€™äº›ç²å‹è€…
                winners.forEach(winner => {
                    const index = remainingCandidates.findIndex(c => c.id === winner.id);
                    if (index > -1) {
                        remainingCandidates.splice(index, 1);
                    }
                });
                
                currentFinalRank += winners.length;
            }
            
            // æŒ‰æœ€çµ‚æ’åæ’åº
            candidatesWithStats.sort((a, b) => a.finalRank - b.finalRank);
            
            // æ ¹æ“šæ’ååˆ†é…çé‡‘ï¼ˆç·šæ€§æ¬Šé‡åˆ†é…ï¼‰
            const totalParticipants = candidatesWithStats.length;
            
            // è™•ç†ä¸¦åˆ—åæ¬¡
            const rankGroups = {};
            candidatesWithStats.forEach(candidate => {
                if (!rankGroups[candidate.finalRank]) {
                    rankGroups[candidate.finalRank] = [];
                }
                rankGroups[candidate.finalRank].push(candidate);
            });
            
            // è¨ˆç®—æ¯å€‹ä½ç½®çš„æ¬Šé‡
            // ç¬¬1åæ¬Šé‡ = n, ç¬¬2åæ¬Šé‡ = n-1, ..., ç¬¬nåæ¬Šé‡ = 1
            const uniqueRanks = Object.keys(rankGroups).map(Number).sort((a, b) => a - b);
            let assignedPosition = 0;
            let totalWeight = 0;
            const rankWeights = {};
            
            uniqueRanks.forEach(rank => {
                const group = rankGroups[rank];
                const groupSize = group.length;
                
                // è¨ˆç®—é€™çµ„çš„ç¸½æ¬Šé‡ï¼ˆå–å¹³å‡ï¼‰
                let groupTotalWeight = 0;
                for (let i = 0; i < groupSize; i++) {
                    groupTotalWeight += (totalParticipants - assignedPosition - i);
                }
                
                rankWeights[rank] = groupTotalWeight / groupSize; // æ¯äººçš„å¹³å‡æ¬Šé‡
                totalWeight += groupTotalWeight;
                assignedPosition += groupSize;
            });
            
            // æŒ‰æ¬Šé‡åˆ†é…çé‡‘
            uniqueRanks.forEach(rank => {
                const group = rankGroups[rank];
                const weightPerPerson = rankWeights[rank];
                const scorePerPerson = (weightPerPerson / totalWeight) * totalPrize;
                
                group.forEach(candidate => {
                    candidate.allocatedScore = Math.round(scorePerPerson * 100) / 100;
                });
            });
            
            // å¾®èª¿ä»¥ç¢ºä¿ç¸½å’Œç­‰æ–¼çé‡‘æ± ï¼ˆè™•ç†å››æ¨äº”å…¥èª¤å·®ï¼‰
            const actualTotal = candidatesWithStats.reduce((sum, c) => sum + c.allocatedScore, 0);
            const diff = totalPrize - actualTotal;
            if (Math.abs(diff) > 0.01 && candidatesWithStats.length > 0) {
                candidatesWithStats[0].allocatedScore = Math.round((candidatesWithStats[0].allocatedScore + diff) * 100) / 100;
            }
            
            return candidatesWithStats;
        }
        
        // æ›´æ–°è¡¨æ ¼
        function updateTable() {
            const sortedCandidates = calculateRankingsAndScores();
            
            // å‰µå»ºé¡è‰²æ¯”ä¾‹å°º
            const maxScore = d3.max(sortedCandidates, d => d.allocatedScore);
            const minScore = d3.min(sortedCandidates, d => d.allocatedScore);
            
            // çé‡‘é¡è‰²æ¯”ä¾‹å°ºï¼ˆç¶ è‰²ç³»ï¼‰
            const scoreColorScale = d3.scaleSequential()
                .domain([minScore, maxScore])
                .interpolator(d3.interpolateGreens);
            
            // æ’åé¡è‰²æ¯”ä¾‹å°ºï¼ˆå€’åºï¼Œç¬¬1åæœ€æ·±ï¼‰
            const rankColorScale = d3.scaleSequential()
                .domain([sortedCandidates.length, 1])
                .interpolator(d3.interpolateBlues);
            
            // ç¥¨æ•¸é¡è‰²æ¯”ä¾‹å°º
            const maxVotes = d3.max(sortedCandidates, d => d.winningVotes);
            const voteColorScale = d3.scaleSequential()
                .domain([0, maxVotes])
                .interpolator(d3.interpolateReds);
            
            let tableHTML = '<thead><tr>';
            tableHTML += '<th class="voter-header">é¸èˆ‰äºº \\ å€™é¸äºº</th>';
            
            sortedCandidates.forEach(candidate => {
                const rankColor = rankColorScale(candidate.finalRank);
                tableHTML += `<th style="background: ${rankColor}; color: white;">${candidate.name}<span class="candidate-rank" style="background: rgba(255,255,255,0.3);">ç¬¬${candidate.finalRank}å</span></th>`;
            });
            tableHTML += '<th class="stats-header">çµ±è¨ˆ</th></tr></thead><tbody>';
            
            // æŠ•ç¥¨çµæœè¡Œ
            voters.forEach(voter => {
                tableHTML += '<tr>';
                tableHTML += `<td style="font-weight: bold; background: #e3f2fd;">${voter.name}</td>`;
                
                sortedCandidates.forEach(candidate => {
                    const vote = votes.find(v => v.voterId === voter.id && v.candidateId === candidate.id);
                    const rank = vote ? vote.rank : null;
                    
                    let cellStyle = '';
                    if (rank) {
                        // ä½¿ç”¨é¡è‰²æ¯”ä¾‹å°ºæ ¹æ“šæ’åè¨­å®šèƒŒæ™¯è‰²
                        const rankValue = rank;
                        const maxRank = voterCount - 1;
                        const colorIntensity = 1 - ((rankValue - 1) / maxRank);
                        
                        if (rank === 1) {
                            cellStyle = 'background: #ffd700; font-weight: bold; color: #c7254e;';
                        } else if (rank === 2) {
                            cellStyle = 'background: #ffeaa7; font-weight: bold;';
                        } else if (rank === 3) {
                            cellStyle = 'background: #fff4cc; font-weight: bold;';
                        } else {
                            // å…¶ä»–æ’åç”¨æ¼¸è®Šè‰²
                            const bgColor = d3.interpolateRgb('#fff', '#e0e0e0')(colorIntensity);
                            cellStyle = `background: ${bgColor};`;
                        }
                    }
                    tableHTML += `<td style="${cellStyle}">${rank || '-'}</td>`;
                });
                
                tableHTML += '<td style="background: #f5f5f5;">-</td></tr>';
            });
            
            // ä¸»è¦å¾—ç¥¨è¡Œï¼ˆåŠ å…¥é¡è‰²ç·¨ç¢¼ï¼‰
            tableHTML += '<tr style="font-weight: bold;">';
            tableHTML += '<td style="background: #67c23a; color: white;">ä¸»è¦å¾—ç¥¨</td>';
            sortedCandidates.forEach(candidate => {
                const voteColor = voteColorScale(candidate.winningVotes);
                tableHTML += `<td style="background: ${voteColor}; color: white;"><div>ç¬¬${candidate.winningRankLevel}åç¥¨</div><div style="font-size: 18px;">${candidate.winningVotes} ç¥¨</div></td>`;
            });
            tableHTML += '<td style="background: #f5f5f5;">-</td></tr>';
            
            // ç²å¾—çé‡‘è¡Œï¼ˆåŠ å…¥é¡è‰²ç·¨ç¢¼ï¼‰
            const totalAllocated = sortedCandidates.reduce((sum, c) => sum + c.allocatedScore, 0);
            tableHTML += '<tr style="font-weight: bold;">';
            tableHTML += '<td style="background: #e6a23c; color: white;">ç²å¾—çé‡‘</td>';
            sortedCandidates.forEach(candidate => {
                const scoreColor = scoreColorScale(candidate.allocatedScore);
                tableHTML += `<td style="background: ${scoreColor}; color: white; font-size: 20px;">ğŸ† ${candidate.allocatedScore} åˆ†</td>`;
            });
            tableHTML += `<td style="background: #fff9e6; font-size: 18px; color: #c7254e;">ç¸½è¨ˆ: ${Math.round(totalAllocated * 100) / 100}åˆ†</td></tr>`;
            
            // å„åæ¬¡åˆ†å¸ƒè¡Œ
            tableHTML += '<tr style="background: #f5f7fa;">';
            tableHTML += '<td style="background: #909399; color: white;">ç¥¨æ•¸åˆ†å¸ƒ</td>';
            sortedCandidates.forEach(candidate => {
                let detailHTML = '<div style="font-size: 12px; padding: 4px;">';
                for (let rank in candidate.rankDistribution) {
                    const count = candidate.rankDistribution[rank];
                    if (count > 0) {
                        detailHTML += `ç¬¬${rank}å: ${count}ç¥¨<br>`;
                    }
                }
                detailHTML += '</div>';
                tableHTML += `<td>${detailHTML}</td>`;
            });
            tableHTML += '<td style="background: #f5f5f5;">-</td></tr>';
            
            tableHTML += '</tbody>';
            document.getElementById('votingTable').innerHTML = tableHTML;
        }
        
        // æ›´æ–°åœ–è¡¨
        function updateCharts() {
            drawStackedBarChart();
            drawRankDistribution();
        }
        
        // ç¹ªè£½çé‡‘åˆ†é… Stacked Bar Chartï¼ˆå–®ä¸€æ©«å‘æ¢å½¢ï¼‰
        function drawStackedBarChart() {
            const sortedCandidates = calculateRankingsAndScores();
            
            d3.select('#stackedBarChart').selectAll('*').remove();
            
            const margin = {top: 50, right: 100, bottom: 80, left: 100};
            const width = 700 - margin.left - margin.right;
            const height = 250 - margin.top - margin.bottom;
            
            const svg = d3.select('#stackedBarChart')
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);
            
            // æº–å‚™ stacked æ•¸æ“š
            let cumulativeX = 0;
            const stackedData = sortedCandidates.map(candidate => {
                const data = {
                    ...candidate,
                    x0: cumulativeX,
                    x1: cumulativeX + candidate.allocatedScore
                };
                cumulativeX += candidate.allocatedScore;
                return data;
            });
            
            // Xè»¸æ¯”ä¾‹å°º
            const x = d3.scaleLinear()
                .domain([0, totalPrize])
                .range([0, width]);
            
            // é¡è‰²æ¯”ä¾‹å°º
            const getColor = (rank) => {
                if (rank === 1) return '#ffd700';
                if (rank === 2) return '#ffeaa7';
                if (rank === 3) return '#fff4cc';
                if (rank === 4) return '#e8f4ff';
                return d3.interpolateRgb('#d4e6f1', '#e0e0e0')((rank - 5) / Math.max(sortedCandidates.length - 5, 1));
            };
            
            // å·¥å…·æç¤º
            const tooltip = d3.select('#tooltip');
            
            const barHeight = 80;
            const barY = (height - barHeight) / 2;
            
            // ç¹ªè£½ stacked segments
            svg.selectAll('.segment')
                .data(stackedData)
                .enter()
                .append('rect')
                .attr('class', 'segment')
                .attr('x', d => x(d.x0))
                .attr('y', barY)
                .attr('width', d => Math.max(x(d.x1) - x(d.x0), 1))
                .attr('height', barHeight)
                .attr('fill', d => getColor(d.finalRank))
                .attr('stroke', 'white')
                .attr('stroke-width', 3)
                .attr('opacity', 0.9)
                .on('mouseover', function(event, d) {
                    tooltip.style('display', 'block')
                        .html(`
                            <strong>${d.name}</strong><br>
                            æ’å: ç¬¬${d.finalRank}å<br>
                            ç²å¾—: ${d.allocatedScore}åˆ†<br>
                            ä½”æ¯”: ${Math.round((d.allocatedScore / totalPrize) * 1000) / 10}%
                        `)
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 10) + 'px');
                    d3.select(this).attr('opacity', 1).attr('stroke-width', 4);
                })
                .on('mouseout', function() {
                    tooltip.style('display', 'none');
                    d3.select(this).attr('opacity', 0.9).attr('stroke-width', 3);
                });
            
            // åœ¨æ¯å€‹å€å¡Šå…§é¡¯ç¤ºè³‡è¨Š
            svg.selectAll('.segment-label')
                .data(stackedData.filter(d => (x(d.x1) - x(d.x0)) > 40))
                .enter()
                .append('g')
                .attr('class', 'segment-label')
                .each(function(d) {
                    const g = d3.select(this);
                    const centerX = x((d.x0 + d.x1) / 2);
                    
                    g.append('text')
                        .attr('x', centerX)
                        .attr('y', barY + barHeight / 2 - 12)
                        .attr('text-anchor', 'middle')
                        .attr('font-size', '12px')
                        .attr('font-weight', 'bold')
                        .attr('fill', '#333')
                        .text(d.name);
                    
                    g.append('text')
                        .attr('x', centerX)
                        .attr('y', barY + barHeight / 2 + 8)
                        .attr('text-anchor', 'middle')
                        .attr('font-size', '16px')
                        .attr('font-weight', 'bold')
                        .attr('fill', '#c7254e')
                        .text(`${d.allocatedScore}`);
                    
                    g.append('text')
                        .attr('x', centerX)
                        .attr('y', barY + barHeight / 2 + 24)
                        .attr('text-anchor', 'middle')
                        .attr('font-size', '10px')
                        .attr('fill', '#666')
                        .text(`#${d.finalRank}`);
                });
            
            // Xè»¸
            svg.append('g')
                .attr('transform', `translate(0,${height - 20})`)
                .call(d3.axisBottom(x).ticks(10));
            
            // Xè»¸æ¨™ç±¤
            svg.append('text')
                .attr('x', width / 2)
                .attr('y', height + 30)
                .attr('text-anchor', 'middle')
                .attr('font-size', '14px')
                .attr('font-weight', 'bold')
                .attr('fill', '#333')
                .text(`çé‡‘åˆ†æ•¸ï¼ˆç¸½çé‡‘æ± : ${totalPrize}åˆ†ï¼‰`);
            
            // æ¨™é¡Œ
            svg.append('text')
                .attr('x', width / 2)
                .attr('y', -25)
                .attr('text-anchor', 'middle')
                .attr('font-size', '18px')
                .attr('font-weight', 'bold')
                .attr('fill', '#333')
                .text('ğŸ† çé‡‘æ± åˆ†é…è¦–è¦ºåŒ–');
        }
        
        // ç¹ªè£½æ’ååˆ†å¸ƒåœ–
        function drawRankDistribution() {
            const sortedCandidates = calculateRankingsAndScores();
            
            d3.select('#rankDistributionChart').selectAll('*').remove();
            
            const margin = {top: 20, right: 30, bottom: 80, left: 60};
            const width = 500 - margin.left - margin.right;
            const height = 400 - margin.top - margin.bottom;
            
            const svg = d3.select('#rankDistributionChart')
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);
            
            // çµ±è¨ˆå„æ’åçš„äººæ•¸
            const rankCounts = {};
            sortedCandidates.forEach(candidate => {
                const rank = candidate.finalRank;
                rankCounts[rank] = (rankCounts[rank] || 0) + 1;
            });
            
            const data = Object.keys(rankCounts).map(rank => ({
                rank: `ç¬¬${rank}å`,
                count: rankCounts[rank]
            }));
            
            // Xè»¸
            const x = d3.scaleBand()
                .domain(data.map(d => d.rank))
                .range([0, width])
                .padding(0.3);
            
            // Yè»¸
            const y = d3.scaleLinear()
                .domain([0, d3.max(data, d => d.count)])
                .nice()
                .range([height, 0]);
            
            // ç¹ªè£½æ¢å½¢åœ–
            svg.selectAll('.bar')
                .data(data)
                .enter()
                .append('rect')
                .attr('class', 'bar')
                .attr('x', d => x(d.rank))
                .attr('y', d => y(d.count))
                .attr('width', x.bandwidth())
                .attr('height', d => height - y(d.count))
                .attr('fill', '#667eea')
                .attr('stroke', '#5568d3')
                .attr('stroke-width', 2)
                .attr('opacity', 0.8);
            
            // é¡¯ç¤ºäººæ•¸
            svg.selectAll('.count-label')
                .data(data)
                .enter()
                .append('text')
                .attr('class', 'count-label')
                .attr('x', d => x(d.rank) + x.bandwidth()/2)
                .attr('y', d => y(d.count) - 5)
                .attr('text-anchor', 'middle')
                .attr('font-size', '16px')
                .attr('font-weight', 'bold')
                .attr('fill', '#333')
                .text(d => `${d.count} äºº`);
            
            // Xè»¸
            svg.append('g')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(x));
            
            // Yè»¸
            svg.append('g')
                .call(d3.axisLeft(y))
                .append('text')
                .attr('transform', 'rotate(-90)')
                .attr('y', -45)
                .attr('x', -height/2)
                .attr('fill', 'black')
                .style('text-anchor', 'middle')
                .text('äººæ•¸');
        }
    </script>
</body>
</html>