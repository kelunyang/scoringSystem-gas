# 定時器設定指南

## 概述

本文檔說明如何在 Google Apps Script (GAS) 中設定定時器觸發器，以自動執行系統維護和清理任務。

## 📋 定時器功能列表

### 1. 每日清理任務 (`runDailyCleanup`)

**執行頻率：** 每天一次  
**建議時間：** 凌晨 2:00-3:00  
**執行時間：** 約 30 秒 - 2 分鐘

**清理內容：**
- ✅ 過期的用戶會話 (超過 24 小時未使用)
- ✅ 過期的邀請碼 (超過有效期限)
- ✅ 過期的密碼重設令牌 (超過 24 小時)
- ✅ 速率限制資料清理 (登入嘗試記錄)
- ✅ 暫存快取項目清理

**重要性：** 🔴 高 - 確保系統安全性和效能

### 2. 每週維護任務 (`runWeeklyMaintenance`)

**執行頻率：** 每週一次  
**建議時間：** 星期日凌晨 3:00-4:00  
**執行時間：** 約 1-5 分鐘

**維護內容：**
- 🔧 清理非活躍專案資料
- 👥 清理非活躍用戶帳號
- 💾 資料庫優化和整理
- 🧹 舊系統屬性清理

**重要性：** 🟡 中等 - 長期系統健康維護

## 🔧 GAS 觸發器設定步驟

### Step 1: 開啟 GAS 觸發器頁面

1. 登入 [Google Apps Script](https://script.google.com)
2. 開啟您的評分系統專案
3. 點擊左側邊欄的 **觸發器** ⏰ 圖示

### Step 2: 設定每日清理觸發器

1. 點擊右下角的 **+ 新增觸發器** 按鈕
2. 填入以下設定：

```
選擇要執行的函式：    runDailyCleanup
選擇事件來源：        時間驅動
選擇時間基礎的觸發器： 日計時器
選擇時間：            凌晨 2 點到 3 點
```

3. 點擊 **儲存**

### Step 3: 設定每週維護觸發器

1. 再次點擊 **+ 新增觸發器** 按鈕
2. 填入以下設定：

```
選擇要執行的函式：    runWeeklyMaintenance
選擇事件來源：        時間驅動
選擇時間基礎的觸發器： 週計時器
選擇星期：            星期日
選擇時間：            凌晨 3 點到 4 點
```

3. 點擊 **儲存**

## 📊 監控和測試功能

### 手動測試觸發器

在 GAS 編輯器中，您可以手動執行以下函數來測試：

```javascript
// 測試每日清理
runDailyCleanup()

// 測試每週維護  
runWeeklyMaintenance()

// 立即執行清理（測試用）
runImmediateCleanup()

// 測試所有定時任務
testScheduledTasks()
```

### 查看執行狀態

```javascript
// 取得上次執行狀態
getCleanupStatus()
```

此函數會回傳：
- 上次每日清理的執行時間和結果
- 上次每週維護的執行時間和結果
- 任何錯誤記錄
- 清理統計資料

## 🚨 故障排除

### 常見問題

**1. 觸發器沒有執行**
- 檢查 GAS 專案的執行權限
- 確認觸發器狀態為「已啟用」
- 查看執行記錄是否有錯誤訊息

**2. 執行時發生錯誤**
- 檢查 GAS 執行記錄 (Stackdriver Logging)
- 使用 `getCleanupStatus()` 查看錯誤詳情
- 確認 PropertiesService 權限正常

**3. 執行時間過長**
- 檢查資料量是否過大
- 考慮分批處理大量資料
- 監控 GAS 執行時間限制（6分鐘）

### 錯誤記錄位置

系統會自動記錄執行結果和錯誤：

**Properties Service 中的記錄鍵值：**
```
LAST_CLEANUP                 // 上次每日清理結果
LAST_WEEKLY_MAINTENANCE      // 上次每週維護結果
```

## ⚙️ 系統屬性配置

確保以下系統屬性已正確設定：

```javascript
// 在 GAS 中執行一次來設定屬性
PropertiesService.getScriptProperties().setProperties({
  'SESSION_TIMEOUT': '86400000',        // 24小時 (毫秒)
  'PASSWORD_SALT_ROUNDS': '10',         // 密碼加密輪數
  'DATABASE_FOLDER_ID': 'your-folder-id' // Google Drive 資料夾ID
});
```

## 📈 效能優化建議

### 執行時間優化

1. **分批處理：** 大量資料分批清理，避免超時
2. **平行處理：** 獨立的清理任務可以平行執行
3. **快取使用：** 優先使用 CacheService 提高存取速度

### 資源使用優化

1. **記憶體管理：** 處理大型資料集時注意記憶體使用
2. **API 配額：** 注意 Google Sheets API 的使用限制
3. **執行時間：** 單次執行不要超過 6 分鐘限制

## 🔔 通知設定

### 執行失敗通知

GAS 預設會在觸發器執行失敗時發送郵件通知給專案擁有者。

**自訂通知設定：**
1. 在 GAS 專案中點擊 **編輯 → 目前專案的觸發器**
2. 點擊已建立的觸發器旁邊的 **三點選單**
3. 選擇 **通知設定**
4. 設定失敗通知頻率

### 監控儀表板

建議定期檢查：
- GAS 執行記錄
- 系統屬性中的執行狀態
- 資料庫大小和效能

## 📋 維護檢查清單

### 每月檢查事項

- [ ] 檢查觸發器執行狀態
- [ ] 查看清理統計資料
- [ ] 檢視系統效能指標
- [ ] 確認無錯誤累積

### 每季檢查事項

- [ ] 評估清理頻率是否適當
- [ ] 檢查資料庫成長趨勢
- [ ] 更新維護策略
- [ ] 效能基準測試

## 🎯 總結

正確設定和監控定時器系統對於維護評分系統的長期穩定運作至關重要。定期檢查執行狀態，並根據系統使用情況調整清理策略，可以確保最佳的系統效能。

---

**重要提醒：** 
- 觸發器設定完成後，請手動執行一次測試
- 定期監控執行記錄和系統狀態
- 如有任何異常，立即檢查錯誤日誌並進行修正