# 評分系統 - 系統總覽文檔

## 專案基本資訊

- **專案名稱**: 評分系統 (Scoring System)
- **技術架構**: Google Apps Script + Vue 3 + Google Sheets
- **認證方式**: Username/Password 認證 (非 Google OAuth)
- **數據庫**: Google Sheets 多分片架構
- **部署方式**: Google Apps Script 網路應用程式

## 系統架構概述

### 前端架構
- **框架**: Vue 3 + Composition API
- **UI庫**: Element Plus (CDN)
- **Markdown編輯器**: EasyMDE
- **圖表庫**: D3.js v7, Chart.js
- **頭像系統**: Dicebear API v7
- **部署**: 嵌入 GAS HTML 頁面，透過 CDN 載入依賴

### 後端架構
- **運行環境**: Google Apps Script
- **API路由**: api_router.js 統一分發
- **數據庫**: Google Sheets 多分片設計
  - 全域工作簿: 用戶、專案、標籤、權限
  - 專案工作簿: 各專案獨立資料
  - 系統工作簿: 日誌系統、通知系統
- **認證**: Session-based 認證系統
- **權限**: 群組式權限管理
- **日誌系統**: 統一日誌架構，支援前後端同步

### 資料庫架構
- **全域工作簿**: 跨專案共享資料
  - Users (含頭像設定)
  - Projects
  - Tags, ProjectTags, UserTags (標籤系統)
  - GlobalGroups, GlobalUserGroups (權限系統)
  
- **專案工作簿**: 每專案獨立
  - 群組管理、階段管理、提交評分
  - 評論系統、投票機制、錢包交易

## 已實現功能清單

### ✅ 核心功能 (完整實現)

#### 1. 使用者認證系統
- **用戶註冊**: 邀請碼機制，支援頭像自定義
- **登入/登出**: Username/Password 認證
- **Session管理**: 基於 sessionId 的會話控制
- **密碼管理**: 加密存儲，支援修改密碼

#### 6. 通知系統 (Notification System)
- **完整通知機制**: 11種通知類型覆蓋所有業務場景
- **即時通知**: 支援評論提及(@username, @groupname)
- **專案管理通知**: 階段生命週期、專案更新、群組管理
- **協作通知**: 成果提交、排名提案、點數獎勵
- **郵件整合**: 每日通知郵件巡檢和發送
- **獨立存儲**: 專用通知試算表，支援自動歸檔
- **用戶控制**: 已讀/未讀狀態管理，通知刪除功能

#### 2. 頭像系統 (Dicebear)
- **前端**: Element Plus `el-avatar` 組件整合
- **後端**: 完整的頭像管理 API
- **註冊流程**: 支援頭像風格和顏色自定義
- **用戶設定**: 頭像重新生成和參數調整
- **徽章系統**: 基於角色的用戶徽章 (Admin, PM, Leader)

#### 3. 標籤管理系統 (Tag-based Scoping)
- **後端**: 完整的標籤 CRUD 操作 (移除category屬性)
- **權限控制**: 管理員可建立標籤
- **作用域機制**: **嚴格標籤匹配** - 只有完全相同標籤集合的實體能互相訪問
- **批次操作**: 支援批次標籤指派
- **前端**: 系統設定頁面完整實現 (表格布局)

#### 4. 權限管理系統
- **群組式權限**: GlobalGroups 和 GlobalUserGroups
- **全域權限**: create_project, system_admin, manage_users, teacher_privilege 等
- **細化權限架構**: 
  - **總PM群組**: 完整系統管理權限 + teacher_privilege
  - **教師群組**: 純教師權限 (僅 teacher_privilege)
  - **權限分離**: 教師投票權限與系統管理權限解耦
- **自動遷移**: 資料庫結構自動升級
- **管理員設置**: 雙群組架構配置

#### 5. 系統管理介面
- **用戶管理**: 查看、編輯、停用用戶
- **標籤管理**: 標籤建立、編輯、狀態管理
- **邀請碼**: 生成和管理邀請碼
- **系統統計**: 基礎統計資訊

#### 7. 統一日誌系統
- **完全整合**: 已將113個console調用完全遷移至統一日誌系統
- **API監控**: 自動記錄所有API請求開始/成功/失敗的完整生命週期
- **前後端同步**: LOG_CONSOLE參數控制前後端console輸出行為一致
- **雙重記錄**: 所有日誌同時記錄到Google Sheets和console (可配置)
- **環境控制**: 開發/生產環境不同的日誌行為，動態可調整
- **結構化存儲**: 12欄位的詳細日誌記錄格式，包含用戶會話追蹤
- **自動歸檔**: 日誌表自動歸檔機制，防止單表過大影響性能
- **統計分析**: 完整的日誌統計和查詢API，支援多維度過濾
- **性能優化**: 日誌記錄對API執行性能無顯著影響

### ⚡ 部分實現功能

#### 1. 專案管理
- **基礎功能**: 建立、查看、更新專案 ✅
- **專案列表**: 基於標籤的權限過濾 ✅
- **專案詳情**: 基礎資料顯示 ✅
- **完整資料API**: 需要格式調整 ⚠️

#### 2. 評論和投票系統
- **後端架構**: 評論表結構完整 ✅
- **前端UI**: 基礎評論介面存在 ✅
- **業務邏輯**: 前後端連接不完整 ⚠️
- **@提及功能**: 後端支援但前端未實現 ⚠️

#### 3. 錢包積分系統
- **後端API**: 錢包相關 API 存在 ✅
- **交易記錄**: 基礎交易表結構 ✅
- **前端顯示**: WalletNew.vue 基礎介面 ✅
- **積分計算**: 邏輯不完整 ⚠️

### ⚡ 部分實現功能

#### 1. 群組管理系統
- **後端**: groups_api.js 完整實現 ✅
- **前端管理**: 群組管理介面已實現，支援搜尋功能 ✅ 
- **用戶群組**: 群組成員管理介面完整 ✅
- **權限設定**: 群組角色權限管理未實現 ⚠️

### ❌ 未實現功能

#### 2. 階段管理系統
- **階段狀態**: 實現 active → voting → completed 狀態流程
- **自動巡邏**: 定時巡邏進程，自動轉換過期階段為 voting 狀態
- **投票機制**: 投票功能只在 voting 狀態啟用
- **通知系統**: 階段狀態變更自動通知參與者

#### 3. 完整評分流程
- **成果提交**: 參與者選擇器已實現，但評分邏輯不完整
- **排名機制**: RankingProposals 和投票機制
- **積分計算**: 自動積分分配邏輯

## 技術特色

### 1. 零成本架構
- **完全免費**: 基於 Google 免費服務
- **無需伺服器**: GAS 提供運算和托管
- **自動備份**: Google Sheets 自動版本控制
- **無限擴展**: 可建立無限個專案工作簿

### 2. 現代前端體驗
- **Vue 3 Composition API**: 現代化元件開發
- **Element Plus UI**: 專業級UI組件庫
- **響應式設計**: 支援桌面和行動裝置
- **即時預覽**: Markdown編輯和頭像自定義

### 3. 完整權限控制
- **標籤作用域**: 基於標籤的資源可見性
- **群組權限**: 靈活的權限繼承機制
- **多層級管理**: 系統管理員、專案管理員、一般用戶

### 4. 開發友善
- **模組化設計**: 前後端清楚分離
- **API文檔完整**: 詳細的API接口說明
- **資料庫文檔**: 完整的表結構說明
- **自動遷移**: 資料庫結構升級機制

## 部署狀態

### 開發環境設定
- ✅ **package.json**: npm scripts 設定完成
- ✅ **構建系統**: scripts/ 到 .gs 的轉換機制
- ✅ **文檔系統**: 完整的系統文檔
- ✅ **代碼規範**: ESLint 和代碼風格指南

### 生產部署需求
- **PropertiesService**: 需設定資料庫文件夾ID
- **全域工作簿**: 需執行系統初始化
- **權限群組設置**: 自動建立總PM群組和教師群組
  - 總PM群組: 完整系統管理權限
  - 教師群組: 純教師投票權限
- **GAS部署**: 網路應用程式部署設定

## 待完成功能優先級

### 🚨 緊急 (影響核心功能)
1. **專案資料格式統一**: 修正 `/projects/complete-data` API格式
2. **評論系統連接**: 完成前後端評論功能連接
3. **錢包交易**: 修正錢包交易記錄顯示

### ⚡ 高優先級 (影響用戶體驗)
1. **群組管理**: 實現前端群組管理介面
2. **投票機制**: 完整的成果投票和評論投票流程
3. **階段管理**: 階段狀態管理和配置介面

### 📈 功能增強 (提升系統價值)
1. **通知系統**: ✅ **已完整實現** - 11種通知類型，涵蓋所有業務場景
2. **報告系統**: 專案進度和統計報告
3. **匯出功能**: 專案資料匯出功能

### 🔧 代碼品質 (提升維護性)
1. **測試覆蓋**: 後端API單元測試
2. **錯誤處理**: 完善前端錯誤處理機制
3. **效能優化**: 快取機制和批次操作優化

## 系統優勢

1. **教育環境適用**: 免費、易管理、直觀的資料檢視
2. **快速部署**: 無需複雜的伺服器設定
3. **彈性擴展**: 支援多專案、多用戶的獨立管理
4. **現代化介面**: 符合現代網頁應用標準的使用體驗
5. **完整權限**: 支援複雜的權限和作用域管理

## 技術債務

1. **API格式不一致**: 部分API回應格式需要標準化
2. **前端Mock資料**: 需清理註釋的Mock資料
3. **錯誤處理**: 部分錯誤處理機制不完整
4. **文檔同步**: 部分新功能的文檔需要更新

## 結論

系統已具備完整的基礎架構和核心功能，特別是用戶管理、權限控制、標籤系統和頭像管理都已完整實現。主要的技術債務集中在業務邏輯的前後端連接，以及部分進階功能的介面實現。

系統的架構設計良好，具有良好的擴展性和維護性，適合作為教育環境的專案評分系統使用。透過完成待辦功能清單，可以成為一個功能完整、體驗優秀的現代化網路應用程式。